!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.madoi=t():e.madoi=t()}(self,(()=>(()=>{"use strict";var e={d:(t,o)=>{for(var n in o)e.o(o,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:o[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{BeforeEnterRoom:()=>S,EnterRoomAllowed:()=>R,EnterRoomDenied:()=>E,GetState:()=>P,HostOnly:()=>b,LeaveRoomDone:()=>O,Madoi:()=>T,PeerEntered:()=>j,PeerLeaved:()=>I,PeerProfileUpdated:()=>_,RoomProfileUpdated:()=>C,SetState:()=>w,Share:()=>v,ShareClass:()=>g,TypedEventTarget:()=>m,getStateConfigDefault:()=>M,newDefineFunction:()=>l,newDefineObject:()=>h,newEnterRoom:()=>r,newInvokeFunction:()=>f,newInvokeMethod:()=>u,newLeaveRoom:()=>d,newPing:()=>i,newUpdateObjectState:()=>p,newUpdatePeerProfile:()=>c,newUpdateRoomProfile:()=>a,shareConfigDefault:()=>y});const o={sender:"__PEER__",castType:"PEERTOSERVER",recipients:void 0},n={sender:"__PEER__",castType:"BROADCAST",recipients:void 0},s={sender:"__PEER__",recipients:void 0};function i(e=void 0){return{type:"Ping",...o,body:e}}function r(e){return{type:"EnterRoom",...o,...e}}function d(e){return{type:"LeaveRoom",...o,...e}}function a(e){return{type:"UpdateRoomProfile",...n,...e}}function c(e){return{type:"UpdatePeerProfile",...n,...e}}function l(e){return{type:"DefineFunction",...o,...e}}function h(e){return{type:"DefineObject",...o,...e}}function f(e,t){return{type:"InvokeFunction",castType:e,...s,...t}}function p(e){return{type:"UpdateObjectState",...o,...e}}function u(e,t){return{type:"InvokeMethod",castType:e,...s,...t}}class m extends EventTarget{addEventListener(...e){super.addEventListener(...e)}removeEventListener(...e){super.removeEventListener(...e)}dispatchCustomEvent(e,t){return super.dispatchEvent(new CustomEvent(e,{detail:t}))}}function g(e={}){return t=>{t.madoiClassConfig_=e}}const y={type:"beforeExec",maxLog:0,allowedTo:["USER"]};function v(e=y){const t=e;return t.type||(t.type="beforeExec"),t.maxLog||(t.maxLog=0),(e,o,n)=>{const s={share:t};e[o].madoiMethodConfig_=s}}const M={maxInterval:5e3};function P(e=M){const t=e;return(e,o,n)=>{const s={getState:t};e[o].madoiMethodConfig_=s}}function w(e={}){const t=e;return(e,o,n)=>{const s={setState:t};e[o].madoiMethodConfig_=s}}function b(e={}){return(t,o,n)=>{const s={hostOnly:e};t[o].madoiMethodConfig_=s}}function S(e={}){const t=e;return(e,o,n)=>{const s={beforeEnterRoom:t};e[o].madoiMethodConfig_=s}}function R(e={}){const t=e;return(e,o,n)=>{const s={enterRoomAllowed:t};e[o].madoiMethodConfig_=s}}function E(e={}){const t=e;return(e,o,n)=>{const s={enterRoomDenied:t};e[o].madoiMethodConfig_=s}}function O(e={}){const t=e;return(e,o,n)=>{const s={leaveRoomDone:t};e[o].madoiMethodConfig_=s}}function C(e={}){const t=e;return(e,o,n)=>{const s={roomProfileUpdated:t};e[o].madoiMethodConfig_=s}}function j(e={}){const t=e;return(e,o,n)=>{const s={peerEntered:t};e[o].madoiMethodConfig_=s}}function I(e={}){const t=e;return(e,o,n)=>{const s={peerLeaved:t};e[o].madoiMethodConfig_=s}}function _(e={}){const t=e;return(e,o,n)=>{const s={peerProfileUpdated:t};e[o].madoiMethodConfig_=s}}class T extends m{connecting=!1;interimQueue;sharedFunctions=new Map;sharedObjects=new Map;sharedMethods=new Map;getStateMethods=new Map;setStateMethods=new Map;beforeEnterRoomMethods=new Map;enterRoomAllowedMethods=new Map;enterRoomDeniedMethods=new Map;leaveRoomDoneMethods=new Map;roomProfileUpdatedMethods=new Map;peerEnteredMethods=new Map;peerLeavedMethods=new Map;peerProfileUpdatedMethods=new Map;url;ws=null;room={id:"",spec:{maxLog:1e3},profile:{}};selfPeer={id:"",order:-1,profile:{}};peers=new Map;currentSender=null;constructor(e,t,o,n){super(),n&&(this.room={...this.room,...n}),o&&(this.selfPeer={...this.selfPeer,...o,order:-1}),this.interimQueue=new Array;const s=-1!=e.indexOf("?")?"&":"?";if(e.match(/^wss?:\/\//))this.url=`${e}${s}authToken=${t}`,this.room.id=e.split("rooms/")[1].split("?")[0];else{const o=document.querySelector("script[src$='madoi.js']").src.split("/",5),n=("http:"==o[0]?"ws:":"wss:")+"//"+o[2]+"/"+o[3];this.url=`${n}/rooms/${e}${s}authToken=${t}`,this.room.id=e}this.ws=new WebSocket(this.url),this.ws.onopen=e=>this.handleOnOpen(e),this.ws.onclose=e=>this.handleOnClose(e),this.ws.onerror=e=>this.handleOnError(e),this.ws.onmessage=e=>this.handleOnMessage(e),setInterval((()=>{this.saveStates()}),1e3),setInterval((()=>{this.sendPing()}),3e4)}getRoomId(){return this.room.id}getRoomProfile(){return this.room?.profile}setRoomProfile(e,t){const o={};o[e]=t,this.sendMessage(a({updates:o}))}removeRoomProfile(e){this.sendMessage(a({deletes:[e]}))}getSelfPeerId(){return this.selfPeer?.id}getSelfPeerProfile(){return this.selfPeer.profile}updateSelfPeerProfile(e,t){this.selfPeer.profile[e]=t;const o={};o[e]=t,this.sendMessage(c({updates:o}))}removeSelfPeerProfile(e){delete this.selfPeer.profile[e],this.sendMessage(c({deletes:[e]}))}getCurrentSender(){return this.currentSender?this.peers.get(this.currentSender):null}isCurrentSenderSelf(){return this.currentSender===this.selfPeer.id}close(){this.ws?.close(),this.ws=null}sendPing(){this.ws?.send(JSON.stringify(i()))}handleOnOpen(e){this.connecting=!0;for(const[e,t]of this.beforeEnterRoomMethods)t(this.selfPeer.profile,this);this.doSendMessage(r({room:this.room,selfPeer:this.selfPeer}));for(let e of this.interimQueue)this.ws?.send(JSON.stringify(e));this.interimQueue=[]}handleOnClose(e){console.debug(`websocket closed because: ${e.reason}.`),this.connecting=!1,this.ws=null}handleOnError(e){}handleOnMessage(e){const t=JSON.parse(e.data);this.currentSender=t.sender,this.data(t)}data(e){if("Pong"==e.type);else if("EnterRoomAllowed"===e.type){const t=e;for(const[e,o]of this.enterRoomAllowedMethods)o(t,this);this.room=e.room,this.selfPeer.order=e.selfPeer.order,this.peers.set(t.selfPeer.id,{...t.selfPeer,profile:this.selfPeer.profile});for(const e of t.otherPeers)this.peers.set(e.id,e);if(this.dispatchCustomEvent("enterRoomAllowed",t),e.histories)for(const t of e.histories)this.data(t)}else if("EnterRoomDenied"===e.type){const t=e;for(const[e,o]of this.enterRoomDeniedMethods)o(t,this);this.dispatchCustomEvent("enterRoomDenied",t)}else if("LeaveRoomDone"==e.type){for(const[e,t]of this.leaveRoomDoneMethods)t(this);this.dispatchCustomEvent("leaveRoomDone")}else if("UpdateRoomProfile"===e.type){const t=e;if(e.updates)for(const[t,o]of Object.entries(e.updates))this.room.profile[t]=o;if(e.deletes)for(const t of e.deletes)delete this.room.profile[t];for(const[e,o]of this.roomProfileUpdatedMethods)o(t,this);this.dispatchCustomEvent("roomProfileUpdated",t)}else if("PeerEntered"===e.type){const t=e;this.peers.set(t.peer.id,t.peer);for(const[e,o]of this.peerEnteredMethods)o(t,this);this.dispatchCustomEvent("peerEntered",t)}else if("PeerLeaved"===e.type){const t=e;this.peers.delete(e.peerId);for(const[e,o]of this.peerLeavedMethods)o(t,this);this.dispatchCustomEvent("peerLeaved",t)}else if("UpdatePeerProfile"===e.type){const t=this.peers.get(e.sender);if(e.sender&&t){if(e.updates)for(const[o,n]of Object.entries(e.updates))t.profile[o]=n;if(e.deletes)for(const o of e.deletes)delete t.profile[o];const o={...e,peerId:e.sender};for(const[e,t]of this.peerProfileUpdatedMethods)t(o,this);this.dispatchCustomEvent("peerProfileUpdated",o)}}else if("InvokeFunction"===e.type){const t=`${e.funcId}`,o=this.sharedFunctions.get(t);if(o){const t=this.applyInvocation(o.original,e.args);t instanceof Promise&&t.then((()=>{o.resolve?.apply(null,arguments)})).catch((()=>{o.reject?.apply(null,arguments)}))}else console.warn("no suitable function for ",e)}else if("UpdateObjectState"===e.type){const t=this.setStateMethods.get(e.objId);t&&t(e.state,e.objRevision);const o=this.sharedObjects.get(e.objId);o&&(o.revision=e.objRevision)}else if("InvokeMethod"===e.type){if(void 0!==e.objId){const t=this.sharedObjects.get(e.objId);void 0!==t&&t.revision++}const t=`${e.objId}:${e.methodId}`,o=this.sharedMethods.get(t);if(o?.original){const t=this.applyInvocation(o.original,e.args);t instanceof Promise&&t.then((()=>{o.resolve?.apply(null,arguments)})).catch((()=>{o.reject?.apply(null,arguments)}))}else console.warn("no suitable method for ",e)}else e.type?this.dispatchEvent(new CustomEvent(e.type,{detail:e})):console.warn("Unknown message type.",e)}systemMessageTypes=["Ping","Pong","EnterRoom","EnterRoomAllowed","EnterRoomDenied","LeaveRoom","LeaveRoomDone","UpdateRoomProfile","PeerArrived","PeerLeaved","UpdatePeerProfile","DefineFunction","DefineObject","InvokeFunction","UpdateObjectState","InvokeMethod"];isSystemMessageType(e){return e in this.systemMessageTypes}send(e,t,o="BROADCAST"){this.ws&&this.sendMessage({type:e,sender:this.selfPeer.id,castType:o,recipients:void 0,content:t})}unicast(e,t,o){this.sendMessage({type:e,sender:this.selfPeer.id,castType:"UNICAST",recipients:[o],content:t})}multicast(e,t,o){this.sendMessage({type:e,sender:this.selfPeer.id,castType:"MULTICAST",recipients:o,content:t})}broadcast(e,t){this.sendMessage({type:e,sender:this.selfPeer.id,castType:"BROADCAST",recipients:void 0,content:t})}othercast(e,t){this.sendMessage({type:e,sender:this.selfPeer.id,castType:"OTHERCAST",recipients:void 0,content:t})}sendMessage(e){if(this.isSystemMessageType(e.type))throw new Error("システムメッセージは送信できません。");this.doSendMessage(e)}addReceiver(e,t){if(this.isSystemMessageType(e))throw new Error("システムメッセージのレシーバは登録できません。");this.addEventListener(e,t)}removeReceiver(e,t){this.removeEventListener(e,t)}replacer(e,t){return t instanceof Map?Object.fromEntries(t):t}doSendMessage(e){this.connecting?this.ws?.send(JSON.stringify(e,this.replacer)):this.interimQueue.push(e)}registerFunction(e,t={share:{}}){if("hostOnly"in t)return this.addHostOnlyFunction(e,t);if("share"in t){t.share.type||(t.share.type=y.type),t.share.maxLog||(t.share.maxLog=y.maxLog);const o=e.name,n=this.sharedFunctions.size,s=this.createFunctionProxy(e,t.share,n),i=function(){return s.apply(null,arguments)};return this.doSendMessage(l({definition:{funcId:n,name:o,config:t}})),i}return e}register(e,t=[]){if(!this.ws)return e;const o=e;if(o.madoiObjectId_)return console.warn("Ignore object registration because it's already registered."),e;let n=o.constructor.name;o.__proto__.constructor.madoiClassConfig_&&(n=o.__proto__.constructor.madoiClassConfig_.className);const s=this.sharedObjects.size,i={instance:o,revision:0,modification:0};this.sharedObjects.set(s,i),o.madoiObjectId_=s;const r=new Array,d=new Array,a=new Map;Object.getOwnPropertyNames(Object.getPrototypeOf(o)).forEach((e=>{const t=o[e];if("function"!=typeof t)return;if(!t.madoiMethodConfig_)return;const s=t.madoiMethodConfig_,i=r.length;a.set(e,i),r.push(t),d.push({methodId:i,name:e,config:s}),console.debug(`add config ${n}.${e}=${JSON.stringify(s)} from decorator`)}));for(const e of t){const t=e.method,o=e,s=t.name;if("share"in o)o.share.type||(o.share.type=y.type),o.share.maxLog||(o.share.maxLog=y.maxLog);else if("hostOnly"in o);else if("getState"in o)o.getState.maxInterval||(o.getState.maxInterval=M.maxInterval);else if("setState"in o);else if("enterRoomAllowed"in o);else if("enterRoomDenied"in o);else if("leaveRoomDone"in o);else if("peerEntered"in o);else if(!("peerLeaved"in o))continue;const i=a.get(s);if(void 0===i){const i=r.length;a.set(s,i),r.push(t),d.push({methodId:i,name:e.method.name,config:o}),console.debug(`add config ${n}.${s}=${JSON.stringify(e)} from argument`)}else d[i].config=e,console.debug(`replace config ${n}.${s}=${JSON.stringify(e)} from argument`)}for(let e=0;e<r.length;e++){const t=r[e],n=d[e],a=n.config;if("share"in a){const e=this.createMethodProxy(t.bind(o),a.share,s,n.methodId);o[n.name]=function(){return i.modification++,e.apply(null,arguments)}}else if("hostOnly"in a){const e=this.addHostOnlyFunction(t.bind(o),a.hostOnly);o[n.name]=function(){return i.modification++,e.apply(null,arguments)}}else"getState"in a?this.getStateMethods.set(s,{method:t.bind(o),config:a.getState,lastGet:0}):"setState"in a?this.setStateMethods.set(s,t.bind(o)):"beforeEnterRoom"in a?this.beforeEnterRoomMethods.set(s,t.bind(o)):"enterRoomAllowed"in a?this.enterRoomAllowedMethods.set(s,t.bind(o)):"enterRoomDenied"in a?this.enterRoomDeniedMethods.set(s,t.bind(o)):"leaveRoomDone"in a?this.leaveRoomDoneMethods.set(s,t.bind(o)):"peerEntered"in a?this.peerEnteredMethods.set(s,t.bind(o)):"peerProfileUpdated"in a?this.peerProfileUpdatedMethods.set(s,t.bind(o)):"peerLeaved"in a&&this.peerLeavedMethods.set(s,t.bind(o))}const c=h({definition:{objId:s,className:n,methods:d}});return this.doSendMessage(c),e}createFunctionProxy(e,t,o){const n=`${o}`,s={original:e};this.sharedFunctions.set(n,s),s.promise=new Promise(((e,t)=>{s.resolve=e,s.reject=t}));const i=this;return function(){if(null!==i.ws){let n=null,r="BROADCAST";return"afterExec"===t.type&&(n=e.apply(null,arguments),r="OTHERCAST"),i.sendMessage(f(r,{funcId:o,args:Array.from(arguments)})),null!=n?n:s.promise}if(e)return e.apply(null,arguments)}}createMethodProxy(e,t,o,n){const s=`${o}:${n}`,i={original:e};this.sharedMethods.set(s,i),i.promise=new Promise(((e,t)=>{i.resolve=e,i.reject=t}));const r=this;return function(){if(null!==r.ws){let s=null,d="BROADCAST";return"afterExec"===t.type&&(s=e.apply(null,[...arguments,r]),d="OTHERCAST"),r.sendMessage(u(d,{objId:o,objRevision:r.sharedObjects.get(o)?.revision,methodId:n,args:Array.from(arguments)})),null!=s?s:i.promise}if(e)return e.apply(null,[...arguments,r])}}addHostOnlyFunction(e,t){const o=this;return function(){let t=o.selfPeer.order;for(const e of o.peers.values())t>e.order&&(t=e.order);o.selfPeer.order===t&&e.apply(null,[...arguments,o])}}saveStates(){if(this.ws&&this.connecting)for(let[e,t]of this.sharedObjects){if(0==t.modification)continue;const o=this.getStateMethods.get(e);if(!o)continue;const n=performance.now();(o.config.maxUpdates&&o.config.maxUpdates<=t.modification||o.config.maxInterval&&o.config.maxInterval<=n-o.lastGet)&&(this.doSendMessage(p({objId:e,objRevision:t.revision,state:o.method(this)})),o.lastGet=n,t.modification=0,console.debug(`state saved: ${e}`))}}applyInvocation(e,t){return e.apply(null,t)}}return t})()));